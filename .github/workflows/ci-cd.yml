test:
  name: Testes Django
  runs-on: ubuntu-latest
  needs: lint

  services:
    postgres:
      image: postgres:15
      env:
        POSTGRES_DB: test_db
        POSTGRES_USER: test_user
        POSTGRES_PASSWORD: test_pass
      ports:
        - 5432:5432
      options: >-
        --health-cmd pg_isready
        --health-interval 10s
        --health-timeout 5s
        --health-retries 5

  steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-python@v5
      with:
        python-version: "3.12"

    - run: pip install poetry
    - run: poetry config virtualenvs.create false
    - run: poetry install --no-interaction

    - name: Run migrations
      env:
        DJANGO_SECRET_KEY: test-secret
        DB_NAME: test_db
        DB_USER: test_user
        DB_PASSWORD: test_pass
        DB_HOST: localhost
        DB_PORT: 5432
      run: python app/manage.py migrate

    - name: Run tests
      env:
        DJANGO_SECRET_KEY: test-secret
        DB_NAME: test_db
        DB_USER: test_user
        DB_PASSWORD: test_pass
        DB_HOST: localhost
        DB_PORT: 5432
      run: python app/manage.py test
